<html>

<head>
    {% include 'html_components/bootstrap.html' %}
    <link href="/static/css/story.css" rel="stylesheet"/>
    <link href="/static/css/background.css" rel="stylesheet"/>
    <script src="/static/scripts/components/BigStoryComponent.js"></script>
</head>

<body>

<!--Navigation bar-->
{% include 'html_components/nav.html' %}
<!--end of Navigation bar-->

<!-- story, marked, val -->

<div class="container" style="width: 100%" id="story-container">
    <script  type="text/javascript">

        storyId = parseInt({{ data | tojson }});
        story = new BigStoryComponent($('#story-container'), storyId)
        story.theme = 'halloween'
        story.text = 'hello world'
        story.date = '25/08/1996'
        story.author = 'giobarty'
        story.authorId = 1
        story.likes = 5
        story.dislikes = 100
        story.currentUser = 'giobarty'
        story.diceSet=['cow','cat','car','mummy']
        story.onLikeCallback= like
        story.onDislikeCallback= dislike
        story.render()

        function like(url) {
            react(url, 'like')
        }

        function dislike(url) {
            react(url, 'dislike')
        }

        function react(url, val) {
            let formData = new FormData()
            var payload = {}
            formData.append('react', val)
            formData.forEach((value, key) => {payload[key] = value});
            var json = JSON.stringify(payload)
            //TODO: UPDATE URL
            fetch("URL", {method: 'POST', body: json})
                .then(response => response.ok ? response.json() : Promise.reject('Story already disliked'))
                .then(data => {
                    if (val === 'like') {
                        story.likes++;
                        if (data.message === 'Reaction updated')
                            story.dislikes--;
                    }
                    else {
                        story.dislikes++;
                        if (data.message === 'Reaction updated')
                            story.likes--;
                    }
                    story.update()
                }).catch(msg => {
                $('#message').text(msg)
            })
        }
    </script>
</div>
</body>

</html>
