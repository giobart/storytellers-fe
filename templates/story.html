<html>

<head>
    {% include 'html_components/bootstrap.html' %}
    <link href="/static/css/story.css" rel="stylesheet"/>
    <link href="/static/css/background.css" rel="stylesheet"/>
    <script src="/static/scripts/components/BigStoryComponent.js"></script>
</head>

<body>

<!--Navigation bar-->
{% include 'html_components/nav.html' %}
<!--end of Navigation bar-->

<!-- story, marked, val -->

<div class="container" style="width: 100%" id="story-container">
    <script  type="text/javascript">

        code = 0
        API_GATEWAY = "http://localhost:8081"
        STORIES_API = "/stories"
        USERS_API = "/users"

        storyId = parseInt({{ data | tojson }});
        $.ajax({
            type: "GET",
            url: API_GATEWAY + STORIES_API,
            crossDomain: true,
            success: function(data) {
                var body = $.parseJSON(data)
                story = new BigStoryComponent($('#story-container'), storyId)
                story.theme = body.theme
                story.text = body.text
                story.date = body.date
                story.authorId = body.author_id
                story.author = get_username(story.authorId)
                story.likes = body.likes
                story.dislikes = body.dislikes
                story.currentUser = ''
                story.diceSet= body.dice_set
                story.onLikeCallback= like
                story.onDislikeCallback= dislike
                story.render()
            },
            error: function (errMsg) {
                $("#message").show()
            }
        });

        function get_username(userid) {
            $.ajax({
            type: "GET",
            url: API_GATEWAY + USERS_API,
            crossDomain: true,
            success: function(data) {
                var body = $.parseJSON(data)
                return body.username
            },
            error: function (errMsg) {
                $("#message").show()
            }
        });
        }        

        function like(url) {
            react(url, 'like')
        }

        function dislike(url) {
            react(url, 'dislike')
        }

        function react(url, val) {
            let formData = new FormData()
            var payload = {}
            formData.append('react', val)
            formData.forEach((value, key) => {payload[key] = value});
            var json = JSON.stringify(payload)
            var path = window.location.pathname.split('/')
            url = path[2] // Get the storyid from url
            fetch(url, {method: 'POST', body: json})
                .then(response => {
                    code = response.status
                    response.json()
                })
                .then(data => {
                    if (val === 'like') {
                        story.likes++;
                        if (data.message === 'Reaction updated')
                            story.dislikes--;
                    }
                    else {
                        story.dislikes++;
                        if (data.message === 'Reaction updated')
                            story.likes--;
                    }
                    story.update()
                })
                .catch(msg => {
                    if (code != 400 && code != 404 && code != 403 && code != 410)
                        msg = 'An error occurred while processing your request. Please try again later.'
                    $('#message').text(msg)
            })
        }
    </script>
</div>
</body>

</html>
