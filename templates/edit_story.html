<html>
<head>
    {% include 'html_components/bootstrap.html' %}
    <link href="/static/css/story.css" rel="stylesheet"/>
    <link href="/static/css/background.css" rel="stylesheet"/>
</head>
<body>

    <!--Navigation bar-->
    {% include 'html_components/nav.html' %}
    <!--end of Navigation bar-->

    <div class="bg-image draft"></div>


    <div class="container d-flex flex-wrap align-items-center bg-text" name="edit-story-container">
        <div class="jumbotron w-100 transparent-bg">

            <form action="/stories/{{ story_id }}" method="PUT" role="form">

                <div class="row">
                    <div class="col-sm-12 center-block text-center">
                        <h5>Current dice values </h5>
                        <b>${this.dice_set}</b>
                        <hr class="style2">
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12 center-block text-center">
                        <textarea class=input name="textarea"></textarea>>

                        <button type="button" id="validate" class="btn btn-success" onclick="submit()">Submit Story</button>
                        <button type="button" id="draft" class="btn btn-primary" onclick="submit_draft()">Submit Draft Story</button>
                        <button type="button" id="cancel" class="btn btn-danger" onclick="cancel_draft()">Cancel</button>
            </form>
        </div>
    </div>

    </div>

</div>


<script>
    let manual_unload = false
    let storyform = document.querySelector('form')

    document.querySelector('#validate').addEventListener('click', evt => {
        manual_unload = true
        storyform.is_draft.checked = false
        storyform.submit()
    })
    document.querySelector('#draft').addEventListener('click', evt => {
        manual_unload = true
        storyform.is_draft.checked = true
        storyform.submit()
    })
    document.querySelector('#cancel').addEventListener('click', evt => {
        manual_unload = true
        fetch("{{ url_for('stories._deleteStory', storyid=story_id) }}", {method: 'DELETE'})
            .then(response => {
                window.location = "{{ url_for('stories._stories') }}"
            })
    })
    window.addEventListener('beforeunload', evt => {
        console.log('event ' + manual_unload)
        if (manual_unload) {
            return false
        }

        evt.preventDefault()
        console.log('beforeunload')
        fetch("{{ url_for('stories._deleteStory', storyid=story_id) }}", {method: 'DELETE'})
        return true
    });
</script>

</body>

</html>
